/*
 @preserve Realtyna Tagging Plugin
 @Author Steve M. @ Realtyna UI Department
 @Copyright 2015 Realtyna Inc.
 */
(function($,window,document,undefined){"use strict";$._realtyna.tagging={version:"1.1.1"};$._realtyna.tagging.init=function(that,options){var defaults={maxWidth:"auto",sortable:true};var R=Realtyna,self=that,opts,tmpls={tagWrap:'<ul class="wpl-gen-tagging-wp"><li class="wpl-gen-tagging-input-wp"></li><li class="wpl-gen-tagging-values-wp"><input class="wpl-gen-tagging-values" type="hidden" /></li></ul>',tagItem:'<li class="wpl-gen-tagging-tag"><span class="wpl-gen-tagging-title"></span><span class="wpl-gen-tagging-close-btn"></span></li>'};opts=$.extend({},defaults,options);var T=$._realtyna.tagging.fn={};T.generateValue=function(tagWrap,saveIt){var titlesItems=tagWrap.find("li").not(".wpl-gen-tagging-input-wp,.wpl-gen-tagging-values-wp").find(".wpl-gen-tagging-title"),value=[];titlesItems.each(function(){value.push($(this).text())});tagWrap.find(".wpl-gen-tagging-values").val(JSON.stringify(value)).trigger("onchange");if(typeof saveIt=="undefined")saveIt=true;if(saveIt)tagWrap.find(".wpl-gen-tagging-values").trigger("onchange")};T.createItem=function(itemValue,tagWrap,saveIt){var newItem;if(typeof saveIt=="undefined")saveIt=true;tagWrap.find(".wpl-gen-tagging-input-wp").before(tmpls.tagItem);newItem=tagWrap.find(".wpl-gen-tagging-input-wp").prev();newItem.find(".wpl-gen-tagging-title").text(itemValue);if(saveIt){T.generateValue(tagWrap,saveIt);tagWrap.sortable("refresh")}newItem.find(".wpl-gen-tagging-close-btn").on("click",function(e){e.preventDefault();var closeBtn=$(this),newItem=closeBtn.parent();if(typeof newItem.data("press-count")=="undefined"){newItem.data("press-count",1)}if(newItem.data("press-count")==1){newItem.addClass("wpl-gen-tagging-will-remove");newItem.data("press-count",2)}else if(newItem.data("press-count")==2){newItem.children().fadeOut(300);newItem.animate({width:"toggle"},250,function(){$(this).remove();T.generateValue(tagWrap)})}})};T.initialize=function(item){var tagWrap;item.after(tmpls.tagWrap);tagWrap=item.next();tagWrap.css({maxWidth:opts.maxWidth});item=item.detach();tagWrap.find(".wpl-gen-tagging-input-wp").append(item);tagWrap.find(".wpl-gen-tagging-values").attr({name:item.attr("name"),id:item.attr("id"),value:item.val(),onchange:item.attr("onchange")});if(item.val().length>0){var values=item.val();if(R.isValidJson(values)){values=JSON.parse(values);for(var i=0;i<values.length;++i){T.createItem(values[i],tagWrap,false)}}}tagWrap.sortable({axis:"x",items:".wpl-gen-tagging-tag",handle:".wpl-gen-tagging-title",placeholder:"wpl-util-placeholder",update:function(event,ui){T.generateValue(tagWrap)}});item.attr({name:null,id:null,onchange:null,value:""});tagWrap.on("click",function(){item.focus()});item.on("keypress",function(e){if(e.which==13&&item.val()!==""){e.preventDefault();T.createItem(item.val(),tagWrap);item.attr("name","");item.val("");tagWrap.find(".wpl-gen-tagging-will-remove").data("press-count",1).removeClass("wpl-gen-tagging-will-remove")}else if(e.which==124){e.preventDefault()}});item.on("keyup",function(e){if(e.which==8&&item.val().length==0){tagWrap.find(".wpl-gen-tagging-input-wp").prev().find(".wpl-gen-tagging-close-btn").trigger("click")}})};self.each(function(){T.initialize($(this))})}})(jQuery,window,document);